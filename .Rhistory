###### limpieza casos por indartamento #####
library(data.table)
library(dplyr)
library(tidyr)
library(tidyverse)
library(lubridate)
## set directory
setwd("~/covid19")
## Call data
#covid_dia <- fread("~/covid19/data/crudas/covidPE_pordia_20200403_MD.csv")
covid_dia <- fread("~/covid19/data/crudas/covidPE_pordia_20200404_MD.csv")
## Checar base
str(covid_dia) # 1412 obs. of  20 variables
names(covid_dia)
head(covid_dia)
# Transform to character
covid_dia <- mutate_if(covid_dia, is.character, toupper)
# Transform to character
covid_dia <- mutate_if(covid_dia, is.character, toupper)
?mutate_if
??mutate_if
library(dplyr)
install.packages("purr")
install.packages("purrr")
library(data.table)
library(dplyr)
library(tidyr)
library(tidyverse)
library(lubridate)
## set directory
setwd("~/covid19")
## Call data
#covid_dia <- fread("~/covid19/data/crudas/covidPE_pordia_20200403_MD.csv")
covid_dia <- fread("~/covid19/data/crudas/covidPE_pordia_20200404_MD.csv")
## Checar base
str(covid_dia) # 29 obs. of  14 variables
names(covid_dia)
head(covid_dia)
# Transform to character
covid_dia <- mutate_if(covid_dia, is.character, toupper)
sapply(covid_dia, class)
### variable by variable
### Fecha ####
table(covid_dia$FECHA)
### ordenar base ###
names(covid_dia)
#### separando caracteres en varias columnas ######
covid_dia$FECHA2 <- covid_dia$FECHA
covid_dia <- separate(covid_dia,
col = "FECHA2",
into = c("DIA", "MES","ANO"),
sep = "/")
##### fecha to as.date format ####
covid_dia<-covid_dia %>%
mutate(FECHA = as.Date(as.character(FECHA), format = "%d/%m/%y"))
### ordenar base ###
names(covid_dia)
covid_dia <- covid_dia[,c(1, 15:17, 2:14)]
# ID del caso
str(covid_dia$CASO_ID) # int
unique(covid_dia$CASO_ID)
## Fecha
str(covid_dia$FECHA) # date
unique(covid_dia$FECHA)
sum(is.na(covid_dia$FECHA)) # 0 NAs
unique(covid_dia$TOTAL_POSITIVOS)
sum(is.na(covid_dia$TOTAL_POSITIVOS)) # 0 NAs
unique(covid_dia$TOTAL_PRUEBAS)
sum(is.na(covid_dia$TOTAL_PRUEBAS)) # 0 NAs
unique(covid_dia$TOTAL_DESCARTADOS)
sum(is.na(covid_dia$TOTAL_DESCARTADOS)) # 0 NAs
unique(covid_dia$POSITIVOS_DIA)
sum(is.na(covid_dia$POSITIVOS_DIA)) # 0 NAs
unique(covid_dia$PRUEBAS_DIA)
sum(is.na(covid_dia$PRUEBAS_DIA)) # 0 NAs
unique(covid_dia$DESCARTADOS_DIA)
sum(is.na(covid_dia$DESCARTADOS_DIA)) # 0
unique(covid_dia$RECUPERADOS)
sum(is.na(covid_dia$RECUPERADOS)) # 10 NAs
unique(covid_dia$FALLECIDOS)
sum(is.na(covid_dia$FALLECIDOS)) # 13 NAs
unique(covid_dia$HOSPITALIZADOS)
sum(is.na(covid_dia$HOSPITALIZADOS)) # 13 NAs
unique(covid_dia$HOSPITALIZADOS_UCI)
sum(is.na(covid_dia$HOSPITALIZADOS_UCI)) # 20 NAs
unique(covid_dia$HOSPITALIZADOS_VENTILADOR)
sum(is.na(covid_dia$HOSPITALIZADOS_VENTILADOR)) # 16 NAs
names(covid_dia)
# Save csv.
# CAMBIA EL NOMBRE! NO TE OLVIDES!
write.csv(covid_dia, "data/modificadas/covidPE_PORdia_20200404_MD_clean.csv")
###### incidencia de Peru casos COVID19#####
library(ggplot2)
library(ggmap)
library(data.table)
library(maptools)
library(rgeos)
library(Cairo)
library(scales)
library(RColorBrewer)
library(rgdal)
library(sp)
library(plyr)
library(tmap)
library(dplyr)
setwd("~/covid19/")
## Call data
# shapefile de peru por regiones
shpfile_peru <- "data/gadm0-1-2-3/peru_1.shp"
sh_peru <- rgdal::readOGR(shpfile_peru)
# casos de covid
#caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200402_MD_clean.csv")
caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200403_MD_clean.csv")
# casos de covid
#caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200402_MD_clean.csv")
# caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200403_MD_clean.csv")
caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200404_MD_clean.csv")
# tabla de poblacion por regiones
pob_region <- read.csv("~/covid19/data/Poblacion por region.csv")
## Check the neighborhood shapefile data and plot
sh_peru@data$NAME_1
# Que quede solo una Lima
sh_peru$NAME_1 <- recode(sh_peru$NAME_1, `Lima Province` = "Lima")
unique(sh_peru$NAME_1)
sh_peru$NAME_1 <- factor(sh_peru$NAME_1)
levels(sh_peru@data$NAME_1)
# Change names
str(sh_peru@data)
levels(sh_peru$NAME_1) <- c(levels(sh_peru$NAME_1),
c("Apurimac", "Huanuco",
"Junin", "San Martin"))
sh_peru_df <- sh_peru@data
sh_peru[3,6] <- "Apurimac"
sh_peru[9,6] <- "Huanuco"
sh_peru[12,6] <- "Junin"
sh_peru[23,6] <- "San Martin"
sh_peru_df <- sh_peru@data
sh_peru@data$NAME_1 <- factor(sh_peru@data$NAME_1)
levels(sh_peru@data$NAME_1)
levels(sh_peru@data$NAME_1)
levels(sh_peru@data$NAME_1)
## plotting shapefiles
plot(sh_peru)
# Transformar a mayusculas
sh_peru[[6]] <- toupper(sh_peru[[6]])
str(sh_peru@data$NAME_1)
unique(sh_peru@data$NAME_1)
## Check data of cases
names(caso_covid)
colnames(caso_covid)[1] <- "CE4_ID"
colnames(caso_covid)[7] <- "NAME_1"
unique(caso_covid$NAME_1)
casos_region <- data.frame(table(caso_covid$NAME_1))
colnames(casos_region)[1] <- "REGION"
colnames(casos_region)[2] <- "NUMERO_CASOS"
## Checar csv de poblaciones regionales
names(pob_region) # "REGION"    "POBLACION"
pob_region[[1]] <- toupper(pob_region[[1]])
unique(pob_region$REGION) # todo ok
## Merge cases with populations
region_values <- merge(casos_region, pob_region, by="REGION",
all.x=T, all.y=T)
## Calcula incidencias
region_values$NUMERO_CASOS <- as.numeric(region_values$NUMERO_CASOS)
region_values$POBLACION <- as.numeric(as.character(region_values$POBLACION))
region_values$incidencia <- region_values$NUMERO_CASOS/region_values$POBLACION
options(digits = 2)
region_values$incidencerate_100 <-(region_values$incidencia*100000)
## recode the names of the region_values data frame
setnames(region_values, old = "REGION",new = "NAME_1")
levels(region_values$NAME_1)
## Create labels that does not occupy
region_values$NAME_LABEL <- region_values$NAME_1
str(region_values$NAME_LABEL)
region_values$NAME_LABEL <- revalue(region_values$NAME_LABEL,
c("ANCASH"="ANC",
"AREQUIPA"="AQP",
"AYACUCHO" ="AYA",
"CAJAMARCA"="CAJ",
"CALLAO"="CAL",
"CUSCO" ="CUS",
"HUANUCO" ="HCO",
"ICA" ="ICA",
"JUNIN" ="JUN",
"LA LIBERTAD" ="LAL",
"LAMBAYEQUE" ="LAM",
"LIMA" ="LIM",
"LORETO"="LOR",
"MADRE DE DIOS"="MDD",
"PASCO" ="PAS",
"PIURA"="PIU",
"SAN MARTIN"="SAM",
"TACNA" ="TAC",
"TUMBES" ="TUM",
"AMAZONAS" ="AMA",
"MOQUEGUA"="MOQ",
"APURIMAC"="APU",
"HUANCAVELICA"="HUV",
"PUNO"="PUN",
"UCAYALI"="UCA"))
## Merge data with shapefile
tmp1 <- sh_peru
tmp1_map <- tmp1
tmp1_map@data <- join(sh_peru@data,region_values, by="NAME_1") # shp with data
tmp1_map_df <- tmp1_map@data
# tmp1_map@data$NUMERO_CASOS[is.na(tmp1_map@data$NUMERO_CASOS)]<-0
# tmp1_map@data$incidencia[is.na(tmp1_map@data$incidencia)]<-0
# tmp1_map@data$incidencerate_100[is.na(tmp1_map@data$incidencerate_100)]<-0
tmp1_map_df <- tmp1_map@data
# tmp1_map@data$brks <- cut(tmp1_map@data$incidencerate_100,
#                            breaks=c(-0.1, 0.0, 1, 2, 3, 4, 5, 6),
#                            labels=c("Sin casos reportados", "0 a 1", "1 a 2", "2 a 3",
#                                     "3 a 4", "4 a 5", "5 a 6"))
names(tmp1_map@data) # check variables
tmp1_map_df <- tmp1_map@data
col <- c("ivory2", "lightcyan1", "lightblue2", #"lightskyblue",
"royalblue", "blue2", "navyblue", "black")
# interactive view
tmap_mode("view")
# crear mapa
qtm <- qtm(tmp1_map, fill = "incidencerate_100",
fill.palette = col,
fill.title="Incidencia por \n100,000 Hab") +
# tm_text("NAME_3", size="0.008", scale=1, root=4,
#         size.lowerbound = .1, bg.color="white", bg.alpha = .15,
#         legend.size.show = FALSE) +
tm_text("NAME_LABEL",size = 0.5)+
tm_layout(paste("Casos por \nregión \nCOVID19 "), title.size = 1,
legend.title.size = 0.8,
legend.text.size = .6, legend.bg.color = "white",
legend.position = c("left","bottom")) #+
qtm <- qtm(tmp1_map, fill = "incidencerate_100",
fill.palette = col,
fill.title="Incidencia por \n100,000 Hab") +
# tm_text("NAME_3", size="0.008", scale=1, root=4,
#         size.lowerbound = .1, bg.color="white", bg.alpha = .15,
#         legend.size.show = FALSE) +
tm_text("NAME_LABEL",size = 0.5)+
tm_layout(paste("Casos COVID19 \npor región"), title.size = 1,
legend.title.size = 0.8,
legend.text.size = .6, legend.bg.color = "white",
legend.position = c("left","bottom")) #+
#tm_view(set.view = c(lon = 15, lat = 48, zoom = 10))
# tm_view(set.view = c(zoom = 10))
print(qtm)
tmap_save(qtm,
paste("outputs_covid19/20200404_Dep_COVID19_Incidencerate",".png", sep=""),
width=2300, height=1380)
library(ggplot2)
library(ggmap)
library(data.table)
library(maptools)
library(rgeos)
library(Cairo)
library(scales)
library(RColorBrewer)
library(rgdal)
library(sp)
library(plyr)
library(tmap)
library(dplyr)
setwd("~/covid19/")
## Call data
# shapefile de peru por regiones
shpfile_peru <- "data/gadm0-1-2-3/peru_1.shp"
sh_peru <- rgdal::readOGR(shpfile_peru)
# casos de covid
#caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200402_MD_clean.csv")
# caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200403_MD_clean.csv")
# casos de covid
#caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200402_MD_clean.csv")
# caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200403_MD_clean.csv")
# caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200404_MD_clean.csv")
caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200405_MD_clean.csv")
# casos de covid
#caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200402_MD_clean.csv")
# caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200403_MD_clean.csv")
# caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200404_MD_clean.csv")
caso_covid <- fread("~/covid19/data/modificadas/covidPE_IND_20200405_CA_clean.csv")
# tabla de poblacion por regiones
pob_region <- read.csv("~/covid19/data/Poblacion por region.csv")
## Check the neighborhood shapefile data and plot
sh_peru@data$NAME_1
# Que quede solo una Lima
sh_peru$NAME_1 <- recode(sh_peru$NAME_1, `Lima Province` = "Lima")
unique(sh_peru$NAME_1)
sh_peru$NAME_1 <- factor(sh_peru$NAME_1)
levels(sh_peru@data$NAME_1)
# Change names
str(sh_peru@data)
levels(sh_peru$NAME_1) <- c(levels(sh_peru$NAME_1),
c("Apurimac", "Huanuco",
"Junin", "San Martin"))
sh_peru_df <- sh_peru@data
sh_peru[3,6] <- "Apurimac"
sh_peru[9,6] <- "Huanuco"
sh_peru[12,6] <- "Junin"
sh_peru[23,6] <- "San Martin"
sh_peru_df <- sh_peru@data
sh_peru@data$NAME_1 <- factor(sh_peru@data$NAME_1)
levels(sh_peru@data$NAME_1)
## plotting shapefiles
plot(sh_peru)
# Transformar a mayusculas
sh_peru[[6]] <- toupper(sh_peru[[6]])
str(sh_peru@data$NAME_1)
unique(sh_peru@data$NAME_1)
## Check data of cases
names(caso_covid)
colnames(caso_covid)[1] <- "CE4_ID"
colnames(caso_covid)[7] <- "NAME_1"
unique(caso_covid$NAME_1)
casos_region <- data.frame(table(caso_covid$NAME_1))
colnames(casos_region)[1] <- "REGION"
colnames(casos_region)[2] <- "NUMERO_CASOS"
## Checar csv de poblaciones regionales
names(pob_region) # "REGION"    "POBLACION"
pob_region[[1]] <- toupper(pob_region[[1]])
unique(pob_region$REGION) # todo ok
## Merge cases with populations
region_values <- merge(casos_region, pob_region, by="REGION",
all.x=T, all.y=T)
## Calcula incidencias
region_values$NUMERO_CASOS <- as.numeric(region_values$NUMERO_CASOS)
region_values$POBLACION <- as.numeric(as.character(region_values$POBLACION))
region_values$incidencia <- region_values$NUMERO_CASOS/region_values$POBLACION
options(digits = 2)
region_values$incidencerate_100 <-(region_values$incidencia*100000)
## recode the names of the region_values data frame
setnames(region_values, old = "REGION",new = "NAME_1")
levels(region_values$NAME_1)
## Create labels that does not occupy
region_values$NAME_LABEL <- region_values$NAME_1
str(region_values$NAME_LABEL)
region_values$NAME_LABEL <- revalue(region_values$NAME_LABEL,
c("ANCASH"="ANC",
"AREQUIPA"="AQP",
"AYACUCHO" ="AYA",
"CAJAMARCA"="CAJ",
"CALLAO"="CAL",
"CUSCO" ="CUS",
"HUANUCO" ="HCO",
"ICA" ="ICA",
"JUNIN" ="JUN",
"LA LIBERTAD" ="LAL",
"LAMBAYEQUE" ="LAM",
"LIMA" ="LIM",
"LORETO"="LOR",
"MADRE DE DIOS"="MDD",
"PASCO" ="PAS",
"PIURA"="PIU",
"SAN MARTIN"="SAM",
"TACNA" ="TAC",
"TUMBES" ="TUM",
"AMAZONAS" ="AMA",
"MOQUEGUA"="MOQ",
"APURIMAC"="APU",
"HUANCAVELICA"="HUV",
"PUNO"="PUN",
"UCAYALI"="UCA"))
## Merge data with shapefile
tmp1 <- sh_peru
tmp1_map <- tmp1
tmp1_map@data <- join(sh_peru@data,region_values, by="NAME_1") # shp with data
tmp1_map_df <- tmp1_map@data
# tmp1_map@data$NUMERO_CASOS[is.na(tmp1_map@data$NUMERO_CASOS)]<-0
# tmp1_map@data$incidencia[is.na(tmp1_map@data$incidencia)]<-0
# tmp1_map@data$incidencerate_100[is.na(tmp1_map@data$incidencerate_100)]<-0
tmp1_map_df <- tmp1_map@data
# tmp1_map@data$brks <- cut(tmp1_map@data$incidencerate_100,
#                            breaks=c(-0.1, 0.0, 1, 2, 3, 4, 5, 6),
#                            labels=c("Sin casos reportados", "0 a 1", "1 a 2", "2 a 3",
#                                     "3 a 4", "4 a 5", "5 a 6"))
names(tmp1_map@data) # check variables
tmp1_map_df <- tmp1_map@data
col <- c("ivory2", "lightcyan1", "lightblue2", #"lightskyblue",
"royalblue", "blue2", "navyblue", "black")
# interactive view
tmap_mode("view")
# crear mapa
qtm <- qtm(tmp1_map, fill = "incidencerate_100",
fill.palette = col,
fill.title="Incidencia por \n100,000 Hab") +
# tm_text("NAME_3", size="0.008", scale=1, root=4,
#         size.lowerbound = .1, bg.color="white", bg.alpha = .15,
#         legend.size.show = FALSE) +
tm_text("NAME_LABEL",size = 0.5)+
tm_layout(paste("Casos COVID19 \npor región"), title.size = 1,
legend.title.size = 0.8,
legend.text.size = .6, legend.bg.color = "white",
legend.position = c("left","bottom")) #+
print(qtm)
# RECUERDA CAMBIAR EL NOMBRE DEL ARCHIVO!
tmap_save(qtm,
paste("outputs_covid19/20200405_Dep_COVID19_Incidencerate",".png", sep=""),
width=2300, height=1380)
